<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shift Log Review</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script> 



    <style>
        /* Basic table styling */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        body { padding: 20px; }
        .container { max-width: 900px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Shift Log Review</h1>

        <div id="review-content"></div>
            <div class="button-group">
            <button class="btn btn-secondary" onclick="window.history.back();">Previous</button>
            <button class="btn btn-primary" onclick="window.print()">Print</button>
            <button class="btn btn-success" onclick="shareAsPDF()">Share as PDF</button> 
        </div>
    </div>
    
    
    <script>
        const reviewContent = document.getElementById('review-content');
        const shiftLogData = JSON.parse(localStorage.getItem('shiftLogData'));

        if (shiftLogData) {
            let html = '';

            html += `<h4>Fuel Prices</h4>
            <p>MS Price: ₹${shiftLogData.msPrice}</p>
            <p>HSD Price: ₹${shiftLogData.hsdPrice}</p>`;

            html += '<h4>Pump Readings</h4><table id="pumpReadingsTable"><thead><tr><th>Pump</th><th>Fuel</th><th>Initial Reading</th><th>Final Reading</th><th>Test</th><th>Pump Earnings (₹)</th></tr></thead><tbody>';
            shiftLogData.pumpData.forEach(item => {
                html += `<tr data-fuel="${item.fuel}" data-initial="${item.initialReading}" data-final="${item.finalReading}" data-test="${item.test}"><td>${item.pump}</td><td>${item.fuel}</td><td>${item.initialReading}</td><td>${item.finalReading}</td><td>${item.test}</td><td></td></tr>`;
            });
            html += '</tbody><tfoot><tr><td colspan="5">Total Earnings (₹)</td><td id="totalPumpEarnings">0</td></tr></tfoot></table>';

            html += '<h4>Payments Received</h4><table id="paymentsReceivedTable"><thead><tr><th>Payment Method</th><th>Initial Amount (₹)</th><th>Final Amount (₹)</th><th>Earnings (₹)</th></tr></thead><tbody>';
            shiftLogData.paymentData.forEach(item => {
                html += `<tr data-initial="${item.initialAmount}" data-final="${item.finalAmount}"><td>${item.method}</td><td>${item.initialAmount}</td><td>${item.finalAmount}</td><td></td></tr>`;
            });
            html += '</tbody><tfoot><tr><td colspan="3">Total Earnings</td><td id="totalPaymentsEarnings">0</td></tr></tfoot></table>';

            html += '<h4>Settlements</h4><table id="settlementsTable"><thead><tr><th>Payment Method</th><th>Amount ₹</th></tr></thead><tbody>';
            shiftLogData.settlementData.forEach(item => {
                html += `<tr data-amount="${item.amount}"><td>${item.method}</td><td>${item.amount}</td></tr>`;
            });
            html += '</tbody><tfoot><tr><td colspan="1">Total Settlements</td><td id="totalSettlements">0</td></tr></tfoot></table>';

            reviewContent.innerHTML = html;
            
            const pumpReadingsTable = document.getElementById('pumpReadingsTable');
            const rows = pumpReadingsTable.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
            let totalPumpEarnings = 0;

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const fuel = row.dataset.fuel;
                const initialReading = parseInt(row.dataset.initial);
                const finalReading = parseInt(row.dataset.final);
                const test = parseInt(row.dataset.test);
                const price = (fuel === 'MS') ? parseFloat(shiftLogData.msPrice) : parseFloat(shiftLogData.hsdPrice);

                const earnings = (finalReading - initialReading - test) * price;
                row.cells[5].textContent = earnings.toFixed(2); // Set the earnings in the last cell
                totalPumpEarnings += earnings;
            }

            document.getElementById('totalPumpEarnings').textContent = totalPumpEarnings.toFixed(2);

            // Payments Received Calculations
            const paymentsTable = document.getElementById('paymentsReceivedTable');
            const paymentRows = paymentsTable.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
            let totalPaymentsEarnings = 0;

            for (let i = 0; i < paymentRows.length; i++) {
                const row = paymentRows[i];
                const initialAmount = parseFloat(row.dataset.initial);
                const finalAmount = parseFloat(row.dataset.final);

                const earnings = finalAmount - initialAmount;
                row.cells[3].textContent = earnings.toFixed(2);
                totalPaymentsEarnings += earnings;
            }

            document.getElementById('totalPaymentsEarnings').textContent = totalPaymentsEarnings.toFixed(2);

            // Settlements Calculations
            const settlementsTable = document.getElementById('settlementsTable');
            const settlementRows = settlementsTable.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
            let totalSettlements = 0;

            for (let i = 0; i < settlementRows.length; i++) {
                const row = settlementRows[i];
                const amount = parseFloat(row.dataset.amount);
                totalSettlements += amount;
            }

            document.getElementById('totalSettlements').textContent = totalSettlements.toFixed(2);


        } else {
            reviewContent.innerHTML = '<p>No data found.</p>';
        }

        // function shareAsPDF() {
        //     window.jsPDF = window.jspdf.jsPDF;
        //     const doc = new jsPDF();
        //     // Add content to PDF
        //     doc.fromHTML(document.getElementById('review-content').innerHTML, 15, 15);
        //     // Save the PDF

        //     doc.save('shift_log_review.pdf');
        //     const link = document.createElement('a');
        //     link.href = URL.createObjectURL(doc.output('blob'));
        //     link.download = 'shift_log_review.pdf';
        //     link.click();
        //  }

         const { jsPDF } = window.jspdf;

        // function shareAsPDF() {
        //     const doc = new jsPDF();
            
        //     // Capture the review content using html2canvas
        //     html2canvas(document.getElementById('review-content')).then(canvas => {
        //         const imgData = canvas.toDataURL('image/png');
        //         const imgWidth = 190; // A4 width in mm
        //         const imgHeight = (canvas.height * imgWidth) / canvas.width; // Maintain aspect ratio
                
        //         doc.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
        //         doc.save('shift_log_review.pdf');
        //     });
        // }


        async function shareAsPDF() {
            const doc = new jsPDF();
            
            // Capture content using html2canvas
            const canvas = await html2canvas(document.getElementById('review-content'));
            const imgData = canvas.toDataURL('image/png');
            const imgWidth = 190; // A4 width in mm
            const imgHeight = (canvas.height * imgWidth) / canvas.width;

            doc.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);

            // Convert to Blob
            const pdfBlob = new Blob([doc.output('blob')], { type: 'application/pdf' });
            const file = new File([pdfBlob], "shift_log_review.pdf", { type: "application/pdf" });

            if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({
                        title: "Shift Log Review",
                        text: "Here is the shift log review PDF.",
                        files: [file]
                    });
                } catch (error) {
                    console.error("Error sharing file:", error);
                    alert("Sharing failed. Please try again.");
                }
            } else {
                alert("Sharing is not supported on this device.");
            }
        }

    </script>

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>